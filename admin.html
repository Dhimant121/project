<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard â€” RedStore</title>
  <style>
    :root{--brand:#2874f0;--muted:#666;--card:#fff;--dark:#111;--bg:#f1f3f6}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:24px}
    .logout-btn{padding:8px 12px;background:#f44336;color:#fff;border:none;border-radius:6px;cursor:pointer}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
    .stat-card{background:var(--card);padding:20px;border-radius:6px;border:1px solid #e6e6e9;text-align:center}
    .stat-value{font-size:28px;font-weight:700;color:var(--brand)}
    .stat-label{color:var(--muted);font-size:13px;margin-top:6px}
    .section{background:var(--card);border:1px solid #e6e6e9;border-radius:6px;padding:20px;margin-bottom:20px}
    h2{margin:0 0 16px;font-size:18px;border-bottom:1px solid #f0f0f0;padding-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:12px;border-bottom:1px solid #e6e6e9;font-weight:600;color:var(--muted);font-size:13px}
    td{padding:12px;border-bottom:1px solid #f0f0f0;font-size:14px}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600}
    .status-pending{background:#fff3cd;color:#856404}
    .status-confirmed{background:#d4edda;color:#155724}
    .status-shipped{background:#cfe2ff;color:#084298}
    .status-delivered{background:#d4edda;color:#155724}
    .action-btn{padding:6px 10px;border-radius:4px;border:none;background:var(--brand);color:#fff;cursor:pointer;font-size:12px;margin-right:6px}
    .action-btn:hover{opacity:0.9}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .form-grid .full{grid-column:1 / -1}
    .form-row{display:grid;gap:6px}
    .form-row label{font-size:12px;color:var(--muted)}
    .form-row input,.form-row textarea,.form-row select{padding:10px;border:1px solid #e6e6e9;border-radius:6px;font-family:inherit;font-size:14px}
    .product-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn-secondary{background:#fff;color:#111;border:1px solid #e6e6e9}
    .danger-btn{background:#f44336}
    .thumb{width:48px;height:48px;border-radius:6px;object-fit:cover;border:1px solid #e6e6e9;background:#fafafa}
    .preview{display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted);font-size:12px}
    @media(max-width:1000px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.stats{grid-template-columns:1fr};table{font-size:12px}td,th{padding:8px}.form-grid{grid-template-columns:1fr}}
  </style>
  <link rel="stylesheet" href="/theme.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ“Š Admin Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-label">Total Orders</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalRevenue">â‚¹0</div>
        <div class="stat-label">Total Revenue</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgOrder">â‚¹0</div>
        <div class="stat-label">Avg Order Value</div>
      </div>
    </div>

    <div class="section">
      <h2>Recent Orders</h2>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr><td colspan="7" style="text-align:center;color:var(--muted)">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Products</h2>
      <div class="muted" style="margin-bottom:12px">Add, edit, or remove products from your catalog.</div>

      <form id="productForm" class="form-grid">
        <input type="hidden" id="productId" value="" />
        <div class="form-row">
          <label for="productTitle">Title</label>
          <input id="productTitle" required />
        </div>
        <div class="form-row">
          <label for="productPrice">Price (â‚¹)</label>
          <input id="productPrice" type="number" min="0" step="1" required />
        </div>
        <div class="form-row">
          <label for="productCategory">Category</label>
          <input id="productCategory" placeholder="men, women, kids, footwear, accessories" />
        </div>
        <div class="form-row">
          <label for="productInventory">Inventory</label>
          <input id="productInventory" type="number" min="0" step="1" value="0" />
        </div>
        <div class="form-row">
          <label for="productImageUrl">Image URL</label>
          <input id="productImageUrl" placeholder="https://..." />
        </div>
        <div class="form-row full">
          <label for="productImageFile">Image Upload</label>
          <input id="productImageFile" type="file" accept="image/*" />
          <div class="preview">
            <img id="productImagePreview" class="thumb" alt="" />
            <span class="muted">Upload an image to preview and use it as the product image.</span>
          </div>
        </div>
        <div class="form-row full">
          <label for="productDesc">Description</label>
          <textarea id="productDesc" rows="3"></textarea>
        </div>
        <div class="product-actions full">
          <button type="submit" class="action-btn">Save Product</button>
          <button type="button" class="action-btn btn-secondary" onclick="resetProductForm()">Clear</button>
        </div>
      </form>

      <div style="margin-top:18px">
        <table id="productsTable">
          <thead>
            <tr>
              <th>Image</th>
              <th>Title</th>
              <th>Category</th>
              <th>Price</th>
              <th>Inventory</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="6" style="text-align:center;color:var(--muted)">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    async function fetchJSON(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok) throw await res.json();
      return res.json();
    }

    async function loadStats(){
      try {
        const stats = await fetchJSON('/api/admin/stats');
        document.getElementById('totalOrders').textContent = stats.totalOrders;
        document.getElementById('totalRevenue').textContent = 'â‚¹' + stats.totalRevenue.toLocaleString();
        document.getElementById('totalUsers').textContent = stats.totalUsers;
        document.getElementById('avgOrder').textContent = 'â‚¹' + stats.avgOrderValue.toLocaleString();
      } catch(err) {
        showNotification('Unauthorized - Admin access only','error');
        window.location.href = '/';
      }
    }

    async function loadOrders(){
      try {
        const orders = await fetchJSON('/api/admin/orders');
        const tbody = document.getElementById('ordersBody');
        
        if(orders.length === 0){
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted)">No orders</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        orders.slice(0, 10).forEach(order => {
          const date = new Date(order.createdAt).toLocaleDateString('en-IN');
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.userName || 'Unknown'}</td>
            <td>â‚¹${order.totalAmount}</td>
            <td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
            <td><span class="status-badge" style="background:#e3f2fd;color:#1976d2">${order.paymentStatus}</span></td>
            <td>${date}</td>
            <td>
              <select class="action-btn" style="padding:6px;cursor:pointer" onchange="updateOrderStatus('${order.id}', this.value)">
                <option value="">Change Status</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
              </select>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch(err) {
        document.getElementById('ordersBody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red">Failed to load orders</td></tr>';
      }
    }

    async function updateOrderStatus(orderId, status){
      if(!status) return;
      try {
        await fetchJSON('/api/admin/order/status', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ orderId, status })
        });
        loadOrders();
      } catch(err) {
        showNotification('Failed to update order','error');
      }
    }

    function logout(){
      fetch('/api/signout', {method:'POST'}).then(() => window.location.href = '/');
    }

    function resetProductForm(){
      document.getElementById('productId').value = '';
      document.getElementById('productTitle').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = '';
      document.getElementById('productImageUrl').value = '';
      document.getElementById('productInventory').value = '0';
      document.getElementById('productDesc').value = '';
      const preview = document.getElementById('productImagePreview');
      preview.src = '';
      preview.style.display = 'none';
      document.getElementById('productImageFile').value = '';
    }

    async function loadProducts(){
      try{
        const products = await fetchJSON('/api/products');
        const tbody = document.getElementById('productsBody');
        if(!products.length){
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted)">No products</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        products.forEach(p => {
          const inv = typeof p.inventory === 'number' ? p.inventory : 0;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.img ? `<img class="thumb" src="${p.img}" alt="">` : '-'}</td>
            <td>${p.title || ''}</td>
            <td>${p.category || ''}</td>
            <td>â‚¹${p.price || 0}</td>
            <td>${inv}</td>
            <td>
              <button class="action-btn" onclick="editProduct(${p.id})">Edit</button>
              <button class="action-btn danger-btn" onclick="deleteProduct(${p.id})">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }catch(err){
        document.getElementById('productsBody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:red">Failed to load products</td></tr>';
      }
    }

    async function editProduct(id){
      try{
        const p = await fetchJSON('/api/products/' + id);
        document.getElementById('productId').value = p.id;
        document.getElementById('productTitle').value = p.title || '';
        document.getElementById('productPrice').value = p.price || 0;
        document.getElementById('productCategory').value = p.category || '';
        document.getElementById('productImageUrl').value = p.img || '';
        document.getElementById('productInventory').value = typeof p.inventory === 'number' ? p.inventory : 0;
        document.getElementById('productDesc').value = p.desc || '';
        const preview = document.getElementById('productImagePreview');
        if(p.img){
          preview.src = p.img;
          preview.style.display = 'inline-block';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }catch(err){
        showNotification('Failed to load product','error');
      }
    }

    async function deleteProduct(id){
      if(!confirm('Delete this product?')) return;
      try{
        await fetchJSON('/api/admin/products/' + id, { method: 'DELETE' });
        loadProducts();
      }catch(err){
        showNotification('Failed to delete product','error');
      }
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('productId').value.trim();
      const payload = {
        title: document.getElementById('productTitle').value.trim(),
        price: parseInt(document.getElementById('productPrice').value, 10) || 0,
        category: document.getElementById('productCategory').value.trim(),
        img: document.getElementById('productImageUrl').value.trim(),
        desc: document.getElementById('productDesc').value.trim(),
        inventory: parseInt(document.getElementById('productInventory').value, 10) || 0
      };
      try{
        if(id){
          await fetchJSON('/api/admin/products/' + id, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        }else{
          await fetchJSON('/api/admin/products', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        }
        resetProductForm();
        loadProducts();
      }catch(err){
        showNotification('Failed to save product','error');
      }
    });

    document.getElementById('productImageFile').addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const form = new FormData();
        form.append('image', file);
        const res = await fetch('/api/admin/upload', { method: 'POST', body: form });
        if(!res.ok) throw new Error('upload failed');
        const data = await res.json();
        const url = data.url || '';
        document.getElementById('productImageUrl').value = url;
        const preview = document.getElementById('productImagePreview');
        preview.src = url;
        preview.style.display = 'inline-block';
      }catch(err){
        showNotification('Image upload failed','error');
      }
    });

    loadStats();
    loadOrders();
    loadProducts();
  </script>
  <script src="/theme.js"></script>
</body>
</html>



